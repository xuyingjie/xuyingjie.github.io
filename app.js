function fileTypeIcons(e){switch(e){case"image/png":case"image/jpeg":case"image/vnd.microsoft.icon":return"fa fa-file-image-o";case"application/x-xz":case"application/gzip":case"application/zip":return"fa fa-file-archive-o";case"text/plain":case"text/x-markdown":return"fa fa-file-text-o";case"application/pdf":return"fa fa-file-pdf-o";case"application/msword":case"application/vnd.oasis.opendocument.text":return"fa fa-file-word-o";default:return"fa fa-file-o"}}function nDown(e,t,o,n){var r=document.getElementById(o);ajaxArrayBuffer({key:o,token:n,uint8Arr:!0,progress:r,success:function(o){var n=new Blob([o.buffer],{type:t}),a=URL.createObjectURL(n),s=document.createElement("a");s.href=a,s.download=e,document.body.appendChild(s);var i=document.createEvent("MouseEvents");i.initEvent("click",!0,!0),s.dispatchEvent(i),document.body.removeChild(s),r.value=0}})}function UTF8ArrToStr(e){for(var t,o="",n=e.length,r=0;n>r;r++)t=e[r],o+=String.fromCharCode(t>251&&254>t&&n>r+5?1073741824*(t-252)+(e[++r]-128<<24)+(e[++r]-128<<18)+(e[++r]-128<<12)+(e[++r]-128<<6)+e[++r]-128:t>247&&252>t&&n>r+4?(t-248<<24)+(e[++r]-128<<18)+(e[++r]-128<<12)+(e[++r]-128<<6)+e[++r]-128:t>239&&248>t&&n>r+3?(t-240<<18)+(e[++r]-128<<12)+(e[++r]-128<<6)+e[++r]-128:t>223&&240>t&&n>r+2?(t-224<<12)+(e[++r]-128<<6)+e[++r]-128:t>191&&224>t&&n>r+1?(t-192<<6)+e[++r]-128:t);return o}function strToUTF8Arr(e){for(var t,o,n=e.length,r=0,a=0;n>a;a++)o=e.charCodeAt(a),r+=128>o?1:2048>o?2:65536>o?3:2097152>o?4:67108864>o?5:6;t=new Uint8Array(r);for(var s=0,i=0;r>s;i++)o=e.charCodeAt(i),128>o?t[s++]=o:2048>o?(t[s++]=192+(o>>>6),t[s++]=128+(63&o)):65536>o?(t[s++]=224+(o>>>12),t[s++]=128+(o>>>6&63),t[s++]=128+(63&o)):2097152>o?(t[s++]=240+(o>>>18),t[s++]=128+(o>>>12&63),t[s++]=128+(o>>>6&63),t[s++]=128+(63&o)):67108864>o?(t[s++]=248+(o>>>24),t[s++]=128+(o>>>18&63),t[s++]=128+(o>>>12&63),t[s++]=128+(o>>>6&63),t[s++]=128+(63&o)):(t[s++]=252+(o>>>30),t[s++]=128+(o>>>24&63),t[s++]=128+(o>>>18&63),t[s++]=128+(o>>>12&63),t[s++]=128+(o>>>6&63),t[s++]=128+(63&o));return t}var Router=ReactRouter,DefaultRoute=Router.DefaultRoute,Link=Router.Link,Route=Router.Route,RouteHandler=Router.RouteHandler,bucket="kxmd",url="http://"+bucket+".oss-cn-beijing.aliyuncs.com/",publicKey="GmPw2qjmTsAAUsqa",local="#/",refresh=!1,converter=new Showdown.converter,db=new Dexie(bucket);db.version(1).stores({etc:"id, version"}),db.version(1).stores({contents:"id, arr"}),db.version(1).stores({set:"id, arr"}),db.version(1).stores({section:"id, title, content, timestamp"}),db.open();var ajaxArrayBuffer=function(e){var t=new XMLHttpRequest;t.onload=function(){if(4===t.readyState&&(t.status>=200&&t.status<300||304===t.status))if(uint8Arr=asmCrypto.AES_CBC.decrypt(t.response,e.token),console.log("AES.decrypt"),e.uint8Arr)e.success(uint8Arr);else{var o=UTF8ArrToStr(uint8Arr);e.success(JSON.parse(o))}},e.progress&&(t.onprogress=function(t){t.lengthComputable&&(e.progress.innerHTML=t.loaded===t.total?(t.total/1024).toFixed(2)+"KB":(t.loaded/t.total*100).toFixed(2)+"%")}),(null!==e.key.match("version")||"folder/list"===e.key)&&(e.key+="?v="+Date.now()),t.open("GET",url+e.key,!0),t.responseType="arraybuffer",t.send(null)},upload=function(e){var t=asmCrypto.AES_CBC.encrypt(e.data,e.token);console.log("AES.encrypt");var o=new Blob([t.buffer],{type:"application/octet-stream"}),n=customForm(e,o),r=new XMLHttpRequest;e.progress&&(r.upload.onprogress=function(t){t.lengthComputable&&(e.progress.value=t.loaded/t.total*100)}),r.onload=function(){4===r.readyState&&(r.status>=200&&r.status<300||304==r.status)&&e.success()},r.open("POST",url,!0),r.send(n)},customForm=function(e,t){var o=JSON.parse(localStorage.user),n=o.AK,r=o.SK,a={expiration:new Date(Date.now()+36e5).toJSON(),conditions:[{bucket:bucket},["eq","$key",e.key]]},s=btoa(JSON.stringify(a)),i=asmCrypto.HMAC_SHA1.base64(s,r),c=new FormData;return c.append("OSSAccessKeyId",n),c.append("policy",s),c.append("signature",i),c.append("key",e.key),c.append("file",t),c},insertText=function(e,t){if(document.selection){var o=document.selection.createRange();o.text=t}else if("number"==typeof e.selectionStart&&"number"==typeof e.selectionEnd){var n=e.selectionStart,r=e.selectionEnd,a=n,s=e.value;e.value=s.substring(0,n)+t+s.substring(r,s.length),a+=t.length,e.selectionStart=e.selectionEnd=a}else e.value+=t},timeDiff=function(){return Date.now()+""+Math.floor(9e3*Math.random()+1e3)};
var Navbar=React.createClass({displayName:"Navbar",handleIndexClick:function(a){a.preventDefault(),this.refs.mainput.getDOMNode().value="",location.href="#/"},handleLogoutClick:function(a){a.preventDefault(),this.props.logout()},handleLoginClick:function(a){a.preventDefault(),local=location.hash,location.href="#/login"},handleMainputChange:function(a){a.preventDefault();var e=this.refs.mainput.getDOMNode().value;e.length>1?location.href="#/s/"+e:""===e&&(location.href="#/")},render:function(){var a;return a=this.props.auth?React.createElement("div",null,React.createElement("a",{className:"navbar-brand",href:"#/a"},React.createElement("span",{className:"fa fa-plus","aria-hidden":"true"})),React.createElement("a",{className:"navbar-brand",href:"#/tasks"},React.createElement("span",{className:"fa fa-tasks","aria-hidden":"true"})),React.createElement("a",{className:"navbar-brand",href:"#/folder"},React.createElement("span",{className:"fa fa-folder","aria-hidden":"true"})),React.createElement("span",{className:"navbar-brand"}),React.createElement("a",{className:"navbar-brand",href:!0,onClick:this.handleLogoutClick},React.createElement("span",{className:"fa fa-sign-out","aria-hidden":"true"}))):React.createElement("div",null,React.createElement("a",{className:"navbar-brand",href:!0,onClick:this.handleLoginClick},React.createElement("span",{className:"fa fa-sign-in","aria-hidden":"true"}))),React.createElement("nav",{className:"navbar navbar-default"},React.createElement("div",{className:"container-fluid"},React.createElement("a",{className:"navbar-brand custom-title",href:!0,onClick:this.handleIndexClick},"KXMD"),React.createElement("form",{className:"navbar-form navbar-left",role:"search",onSubmit:this.handleMainputChange},React.createElement("input",{type:"text",className:"form-control mainput",ref:"mainput",onChange:this.handleMainputChange})),React.createElement("div",{className:"navbar-right"},a)))}});
var Contents=React.createClass({displayName:"Contents",getInitialState:function(){return{contents:[]}},sort:function(){if(0===this.state.contents.length){var t=this.props.contents.slice(0);t.sort(this.props.auth?function(t,e){return e.timestamp-t.timestamp}:function(t,e){return t.title.localeCompare(e.title)}),this.setState({contents:t})}else clearInterval(this.interval)},componentDidMount:function(){this.interval=setInterval(this.sort,5)},componentWillUnmount:function(){clearInterval(this.interval)},render:function(){return React.createElement("div",{className:"container-fluid"},this.state.contents.map(function(t){return React.createElement("a",{className:"btn btn-default",href:"#/t/"+t.id,role:"button"},t.title)}))}});
var Section=React.createClass({displayName:"Section",mixins:[Router.State],getInitialState:function(){return{section:[],keyword:""}},loadIMG:function(e){ajaxArrayBuffer({key:e.dataset.key,token:publicKey,uint8Arr:!0,success:function(t){var n=new Blob([t.buffer],{type:e.dataset.type}),i=URL.createObjectURL(n),a=document.createElement("img");a.src=i,e.replaceChild(a,e.firstElementChild),e.setAttribute("name","dec-img")}})},imgEvent:function(){for(var e=document.getElementsByName("enc-img"),t=0;t<e.length;t++){var n=e[t].getBoundingClientRect().top;n>0&&n<window.innerHeight&&this.loadIMG(e[t])}},query:function(){if(this.getParams().id)refresh&&(console.log("Index"),db.section.get(this.getParams().id,function(e){e&&(this.setState({section:[e]}),refresh=!1,this.imgEvent(),window.onscroll=this.imgEvent)}.bind(this)));else if(this.getParams().keyword&&0!==this.props.set.length){var e=this.getParams().keyword;if(e!==this.state.keyword||refresh){console.log("Query");var t=[],n=new RegExp(e,"i");this.props.set.forEach(function(e){(null!==e.title.match(n)||null!==e.content.match(n))&&t.push(e)}),this.setState({section:t}),this.setState({keyword:e}),refresh=!1,this.imgEvent(),window.onscroll=this.imgEvent}}},componentDidMount:function(){refresh=!0,this.query(),this.interval=setInterval(this.query,200)},componentWillUnmount:function(){clearInterval(this.interval)},render:function(){return React.createElement("div",null,this.state.section.map(function(e){var t=React.createElement("div",null);this.props.auth&&(t=React.createElement("a",{className:"label label-default",href:"#/e/"+e.id},"编辑"));var n=converter.makeHtml(e.content);return React.createElement("div",null,React.createElement("div",{className:"container-fluid"},React.createElement("h2",null,e.title),React.createElement("span",{dangerouslySetInnerHTML:{__html:n}}),t),React.createElement("hr",null))}.bind(this)))}});
var SignIn=React.createClass({displayName:"SignIn",handleSubmit:function(e){e.preventDefault();var t=this.refs.name.getDOMNode().value,a=this.refs.passwd.getDOMNode().value;ajaxArrayBuffer({key:t,token:a,success:function(e){localStorage.token=e.user.token,localStorage.user=JSON.stringify(e.user),this.props.login(),this.refs.name.getDOMNode().value="",this.refs.passwd.getDOMNode().value=""}.bind(this)})},render:function(){return React.createElement("div",{className:"container-fluid"},React.createElement("div",{className:"row"},React.createElement("div",{className:"col-sm-5"},React.createElement("form",{onSubmit:this.handleSubmit},React.createElement("div",{className:"form-group"},React.createElement("label",{htmlFor:"inputName3"},"Name"),React.createElement("input",{type:"text",className:"form-control",id:"inputName3",ref:"name"})),React.createElement("div",{className:"form-group"},React.createElement("label",{htmlFor:"inputPassword3"},"Password"),React.createElement("input",{type:"password",className:"form-control",id:"inputPassword3",ref:"passwd"})),React.createElement("button",{type:"submit",className:"btn btn-default"},"Sign in")))))}});
var SignUp=React.createClass({displayName:"SignUp",handleSubmit:function(e){e.preventDefault();var t=this.refs.name.getDOMNode().value,a=this.refs.passwd.getDOMNode().value,r=this.refs.token.getDOMNode().value,c=this.refs.AK.getDOMNode().value,l=this.refs.SK.getDOMNode().value,s={AK:c,SK:l,token:r};localStorage.token=r,localStorage.user=JSON.stringify(s),upload({key:t,data:strToUTF8Arr(JSON.stringify({user:s})),token:a,success:function(){console.log("Success!"),this.refs.status.getDOMNode().value="Success!"}.bind(this)})},render:function(){return React.createElement("div",{className:"container-fluid"},React.createElement("div",{className:"row"},React.createElement("div",{className:"col-sm-5"},React.createElement("form",{onSubmit:this.handleSubmit},React.createElement("div",{className:"form-group"},React.createElement("label",{htmlFor:"inputName3"},"Name"),React.createElement("input",{type:"text",className:"form-control",id:"inputName3",ref:"name"})),React.createElement("div",{className:"form-group"},React.createElement("label",{htmlFor:"inputPassword3"},"Password"),React.createElement("input",{type:"text",className:"form-control",id:"inputPassword3",ref:"passwd"})),React.createElement("div",{className:"form-group"},React.createElement("label",{htmlFor:"token"},"Token"),React.createElement("input",{type:"text",className:"form-control",id:"token",ref:"token"})),React.createElement("div",{className:"form-group"},React.createElement("label",{htmlFor:"AK"},"AK"),React.createElement("input",{type:"text",className:"form-control",id:"AK",ref:"AK"})),React.createElement("div",{className:"form-group"},React.createElement("label",{htmlFor:"SK"},"SK"),React.createElement("input",{type:"text",className:"form-control",id:"SK",ref:"SK"})),React.createElement("button",{type:"submit",className:"btn btn-default"},"Sign up"))),React.createElement("div",{className:"col-sm-5"},React.createElement("textarea",{ref:"status"}))))}});
var Editor=React.createClass({displayName:"Editor",mixins:[Router.State],getInitialState:function(){return{section:{id:"",title:"",content:""}}},tick:function(){this.getParams().id&&db.section.get(this.getParams().id,function(e){e&&(this.setState({section:e}),clearInterval(this.interval))}.bind(this))},componentDidMount:function(){this.interval=setInterval(this.tick,5)},componentWillUnmount:function(){clearInterval(this.interval)},handleTitleChange:function(e){var t=this.state.section;t.title=e.target.value,this.setState({section:t})},handleContentChange:function(e){var t=this.state.section;t.content=e.target.value,this.setState({section:t})},uploadFile:function(e){e.preventDefault();var t=document.getElementById("file").files[0],a=new FileReader;a.onload=function(){var e="u/"+timeDiff(),n=document.getElementById("upload-progress");upload({key:e,data:a.result,token:publicKey,progress:n,success:function(){var a="";"image/png"===t.type||"image/jpeg"===t.type||"image/vnd.microsoft.icon"===t.type?(a+='\n<div name="enc-img" data-name="'+t.name+'" data-type="'+t.type+'" data-key="'+e,a+='"><span class="fa fa-spinner fa-pulse fa-2x"></span></div>'):(a+='\n<a class="btn btn-default" onclick="nDown(\''+t.name+"','"+t.type+"','"+e+"','"+publicKey+"')",a+='"><span class="'+fileTypeIcons(t.type)+' fa-lg"></span>&nbsp;'+t.name+'&nbsp;<span id="'+e+'">'+(t.size/1024).toFixed(2)+"KB</span></a>");var i=document.getElementById("content");insertText(i,a);var s=this.state.section;s.content=i.value,this.setState({section:s}),document.getElementById("file").value="",n.value=0}.bind(this)})}.bind(this),a.readAsArrayBuffer(t)},uploadSetToServer:function(e){e.preventDefault(),this.props.uploadSetToServer(this.state.section)},render:function(){var e=this.state.section;return React.createElement("div",{className:"container-fluid"},React.createElement("form",{onSubmit:this.uploadSetToServer},React.createElement("div",{className:"form-group"},React.createElement("input",{type:"text",className:"form-control",placeholder:"key",onChange:this.handleTitleChange,value:e.title})),React.createElement("div",{className:"form-group"},React.createElement("textarea",{id:"content",className:"form-control",rows:"17",placeholder:"value",onChange:this.handleContentChange,value:e.content})),React.createElement("button",{type:"submit",className:"btn btn-default pull-right"},"Save")),React.createElement("form",{encType:"multipart/form-data",onSubmit:this.uploadFile},React.createElement("input",{id:"file",type:"file",required:!0,accept:!0}),React.createElement("button",{type:"submit",className:"btn btn-default"},"Insert")),React.createElement("progress",{id:"upload-progress",min:"0",max:"100",value:"0"},"0"))}});
var Folder=React.createClass({displayName:"Folder",getInitialState:function(){return{list:[]}},componentDidMount:function(){ajaxArrayBuffer({key:"folder/list",token:localStorage.token,success:function(e){this.setState({list:e.list})}.bind(this)})},download:function(e){nDown(e.name,e.type,e.key,localStorage.token)},uploadFile:function(e){e.preventDefault();var t=document.getElementById("file").files[0],a=new FileReader;a.onload=function(){var e="folder/"+timeDiff();upload({key:e,data:a.result,token:localStorage.token,progress:document.getElementById("upload-progress"),success:function(){var a={key:e,name:t.name,type:t.type,size:t.size},n=this.state.list;n.push(a),upload({key:"folder/list",data:strToUTF8Arr(JSON.stringify({list:n})),token:localStorage.token,success:function(){console.log("Upload!!!"),this.setState({list:n}),document.getElementById("file").value="",document.getElementById("upload-progress").value=0}.bind(this)})}.bind(this)})}.bind(this),a.readAsArrayBuffer(t)},render:function(){var e=this.state.list.slice(0).reverse();return React.createElement("div",{className:"container-fluid"},React.createElement("form",{encType:"multipart/form-data",onSubmit:this.uploadFile},React.createElement("input",{id:"file",type:"file",required:!0,accept:!0}),React.createElement("button",{type:"submit",className:"btn btn-default"},"Insert")),React.createElement("progress",{id:"upload-progress",min:"0",max:"100",value:"0"},"0"),React.createElement("ul",{className:"list-group"},e.map(function(e){return React.createElement("a",{className:"list-group-item",key:e.key,href:"#/folder",onClick:this.download.bind(this,e)},React.createElement("i",{className:fileTypeIcons(e.type)+" fa-fw fa-lg"})," ",e.name,React.createElement("span",{id:e.key,className:"pull-right"},(e.size/1024).toFixed(2)+"KB"))}.bind(this))))}});
var Tasks=React.createClass({displayName:"Tasks",getInitialState:function(){return{version:0,tasks:[],query:[],editID:""}},loadTasks:function(){ajaxArrayBuffer({key:"tasks/"+this.state.version,token:localStorage.token,success:function(t){this.setState({tasks:t.tasks}),this.setState({query:t.tasks})}.bind(this)})},componentDidMount:function(){ajaxArrayBuffer({key:"tasks/version",token:localStorage.token,success:function(t){this.setState({version:t.version}),this.loadTasks()}.bind(this)})},handleChange:function(t){var e=t.target.value,s=[],a=new RegExp(e,"i");this.state.tasks.forEach(function(t){null!==t.content.match(a)&&s.push(t)}),this.setState({query:s})},handleEdit:function(t){this.setState({editID:t.id}),this.refs.content.getDOMNode().value=t.content},save:function(t){if(t.preventDefault(),""!==this.refs.content.getDOMNode().value){var e=this.state.version+1,s=this.state.tasks;if(""!==this.state.editID)for(var a in s)this.state.editID===s[a].id&&(s.splice(a,1),this.setState({editID:""}));var n={id:timeDiff(),content:this.refs.content.getDOMNode().value};s.push(n),upload({key:"tasks/"+e,data:strToUTF8Arr(JSON.stringify({tasks:s})),token:localStorage.token,success:function(){upload({key:"tasks/version",data:strToUTF8Arr(JSON.stringify({version:e})),token:localStorage.token,success:function(){this.setState({version:e}),this.setState({query:s}),this.refs.content.getDOMNode().value=""}.bind(this)})}.bind(this)})}},render:function(){var t=this.state.query.slice(0).reverse();return React.createElement("div",{className:"container-fluid"},React.createElement("form",{onSubmit:this.save},React.createElement("div",{className:"form-group"},React.createElement("input",{type:"text",className:"form-control tasks",placeholder:"tasks",onChange:this.handleChange,ref:"content"}))),t.map(function(t){return React.createElement("div",{className:"tasks-margin"},React.createElement("span",{className:"tasks"},t.content," ",React.createElement("a",{href:"#/tasks",onClick:this.handleEdit.bind(this,t)},React.createElement("i",{className:"fa fa-pencil"}))))}.bind(this)))}});
var Root=React.createClass({displayName:"Root",getInitialState:function(){return{version:0,contents:[],set:[],auth:!1}},loadSetFromServer:function(){ajaxArrayBuffer({key:"set/"+this.state.version,token:publicKey,success:function(t){var e=[];t.set.forEach(function(t){var n={id:t.id,title:t.title,timestamp:t.timestamp};e.push(n)}),this.setState({contents:e}),this.setState({set:t.set}),this.cacheToIndexedDB(),refresh=!0}.bind(this)})},cacheToIndexedDB:function(){var t=this.state.version;db.etc.put({id:"version",version:t}),db.contents.put({id:t,arr:this.state.contents}),db.set.put({id:t,arr:this.state.set}),this.state.set.forEach(function(t){db.section.put(t).then(function(){refresh=!0})})},loadSetFromIndexedDB:function(){var t=this.state.version;db.contents.get(t,function(t){this.setState({contents:t.arr})}.bind(this)),db.set.get(t,function(t){this.setState({set:t.arr})}.bind(this))},cache:function(){ajaxArrayBuffer({key:"version",token:publicKey,success:function(t){this.setState({version:t.version}),db.etc.get("version",function(t){t&&t.version===this.state.version?(console.log("LoadSetFromIndexedDB"),this.loadSetFromIndexedDB()):(console.log("LoadSetFromServer"),this.loadSetFromServer())}.bind(this))}.bind(this)})},handleUploadSetToServer:function(t){if(""!==t.title){var e=this.state.version+1,n=this.state.contents,a=this.state.set,o={id:t.id,title:t.title,timestamp:Date.now()};if(""===o.id)o.id=timeDiff(),n.push(o),o.content=t.content,a.push(o);else for(var s in n)o.id===n[s].id&&(n[s]=o,o.content=t.content,a[s]=o);this.setState({version:e}),this.setState({contents:n}),this.setState({set:a}),db.section.put(o),db.etc.put({id:"version",version:e}),db.contents.put({id:e,arr:n}),db.set.put({id:e,arr:a}),upload({key:"set/"+e,data:strToUTF8Arr(JSON.stringify({set:a})),token:publicKey,success:function(){upload({key:"version",data:strToUTF8Arr(JSON.stringify({version:e})),token:publicKey,success:function(){console.log("Save!!!"),location.href="#/t/"+o.id}})}})}},handleLogin:function(){this.setState({auth:!0}),location.href=local},handleLogout:function(){localStorage.removeItem("token"),localStorage.removeItem("user"),this.setState({auth:!1}),location.replace("#/")},auth:function(){localStorage.token&&this.setState({auth:!0})},componentDidMount:function(){this.auth(),this.cache()},render:function(){return React.createElement("div",null,React.createElement(Navbar,{auth:this.state.auth,logout:this.handleLogout}),React.createElement(RouteHandler,React.__spread({},this.state,{uploadSetToServer:this.handleUploadSetToServer,login:this.handleLogin})))}}),routes=React.createElement(Route,{path:"/",handler:Root},React.createElement(Route,{name:"t",path:"/t/:id",handler:Section}),React.createElement(Route,{name:"s",path:"/s/:keyword",handler:Section}),React.createElement(Route,{name:"a",handler:Editor}),React.createElement(Route,{name:"e",path:"/e/:id",handler:Editor}),React.createElement(Route,{name:"login",handler:SignIn}),React.createElement(Route,{name:"join",handler:SignUp}),React.createElement(Route,{name:"folder",handler:Folder}),React.createElement(Route,{name:"tasks",handler:Tasks}),React.createElement(DefaultRoute,{handler:Contents}));Router.run(routes,function(t){React.render(React.createElement(t,null),document.body)});
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(e.__proto__=t)}function ajaxArrayBuffer(e){var t=new XMLHttpRequest;t.onload=function(){if(4===t.readyState&&(t.status>=200&&t.status<300||304===t.status)){var n=t.response;if(encrypt||e.token){var a=e.token?e.token:localStorage.token;n=asmCrypto.AES_CBC.decrypt(t.response,a).buffer}if(e.arrayBuffer)e.success(n);else{var r=utf8ArrToStr(new Uint8Array(n));e.success(JSON.parse(r))}}},e.progress&&(t.onprogress=function(t){t.lengthComputable&&(e.progress.style.width=t.loaded===t.total?"0%":(t.loaded/t.total*100).toFixed(2)+"%")}),null!==e.key.match("version")&&(e.key+="?v="+Date.now()),t.open("GET",url+e.key,!0),t.responseType="arraybuffer",t.send(null)}function upload(e){if(e.arrayBuffer||(e.data=strToUTF8Arr(e.data).buffer),encrypt||e.token){var t=e.token?e.token:localStorage.token;e.data=asmCrypto.AES_CBC.encrypt(e.data,t).buffer}var n=new Blob([e.data]),a=customForm(e,n),r=new XMLHttpRequest;e.progress&&(r.upload.onprogress=function(t){t.lengthComputable&&(e.progress.style.width=t.loaded===t.total?"0%":(t.loaded/t.total*100).toFixed(2)+"%")}),r.onload=function(){4===r.readyState&&(r.status>=200&&r.status<300||304==r.status)&&e.success()},r.open("POST","http://upload.qiniu.com",!0),r.send(a)}function customForm(e,t){var n=JSON.parse(localStorage.user),a=n.AK,r=n.SK,o={scope:bucket+":"+e.key,deadline:3600+Math.floor(Date.now()/1e3)},i=btoa(JSON.stringify(o)),s=asmCrypto.HMAC_SHA1.base64(i,r),l=new FormData;return l.append("token",a+":"+safe64(s)+":"+i),l.append("key",e.key),l.append("file",t),l}function safe64(e){return e=e.replace(/\+/g,"-"),e=e.replace(/\//g,"_")}function insertText(e,t){if(document.selection){var n=document.selection.createRange();n.text=t}else if("number"==typeof e.selectionStart&&"number"==typeof e.selectionEnd){var a=e.selectionStart,r=e.selectionEnd,o=a,i=e.value;e.value=i.substring(0,a)+t+i.substring(r,i.length),o+=t.length,e.selectionStart=e.selectionEnd=o}else e.value+=t}function fileTypeIcons(e){switch(e){case"image/png":case"image/jpeg":case"image/vnd.microsoft.icon":return"fa fa-file-image-o";case"application/x-xz":case"application/gzip":case"application/zip":return"fa fa-file-archive-o";case"text/plain":case"text/x-markdown":return"fa fa-file-text-o";case"application/pdf":return"fa fa-file-pdf-o";case"application/msword":case"application/vnd.oasis.opendocument.text":return"fa fa-file-word-o";default:return"fa fa-file-o"}}function successInfo(e){var t=document.createElement("div");t.innerHTML='<div id="success-info">'+e+"</div>",document.body.appendChild(t);var n=setTimeout(function(){document.body.removeChild(t),clearTimeout(n)},700)}function timeDiff(){return Date.now()+""+Math.floor(9e3*Math.random()+1e3)}function utf8ArrToStr(e){for(var t,n="",a=e.length,r=0;a>r;r++)t=e[r],n+=String.fromCharCode(t>251&&254>t&&a>r+5?1073741824*(t-252)+(e[++r]-128<<24)+(e[++r]-128<<18)+(e[++r]-128<<12)+(e[++r]-128<<6)+e[++r]-128:t>247&&252>t&&a>r+4?(t-248<<24)+(e[++r]-128<<18)+(e[++r]-128<<12)+(e[++r]-128<<6)+e[++r]-128:t>239&&248>t&&a>r+3?(t-240<<18)+(e[++r]-128<<12)+(e[++r]-128<<6)+e[++r]-128:t>223&&240>t&&a>r+2?(t-224<<12)+(e[++r]-128<<6)+e[++r]-128:t>191&&224>t&&a>r+1?(t-192<<6)+e[++r]-128:t);return n}function strToUTF8Arr(e){for(var t,n,a=e.length,r=0,o=0;a>o;o++)n=e.charCodeAt(o),r+=128>n?1:2048>n?2:65536>n?3:2097152>n?4:67108864>n?5:6;t=new Uint8Array(r);for(var i=0,s=0;r>i;s++)n=e.charCodeAt(s),128>n?t[i++]=n:2048>n?(t[i++]=192+(n>>>6),t[i++]=128+(63&n)):65536>n?(t[i++]=224+(n>>>12),t[i++]=128+(n>>>6&63),t[i++]=128+(63&n)):2097152>n?(t[i++]=240+(n>>>18),t[i++]=128+(n>>>12&63),t[i++]=128+(n>>>6&63),t[i++]=128+(63&n)):67108864>n?(t[i++]=248+(n>>>24),t[i++]=128+(n>>>18&63),t[i++]=128+(n>>>12&63),t[i++]=128+(n>>>6&63),t[i++]=128+(63&n)):(t[i++]=252+(n>>>30),t[i++]=128+(n>>>24&63),t[i++]=128+(n>>>18&63),t[i++]=128+(n>>>12&63),t[i++]=128+(n>>>6&63),t[i++]=128+(63&n));return t}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),_get=function(e,t,n){for(var a=!0;a;){var r=e,o=t,i=n;s=c=l=void 0,a=!1,null===r&&(r=Function.prototype);var s=Object.getOwnPropertyDescriptor(r,o);if(void 0!==s){if("value"in s)return s.value;var l=s.get;return void 0===l?void 0:l.call(i)}var c=Object.getPrototypeOf(r);if(null===c)return void 0;e=c,t=o,n=i,a=!0}},Attachment=function(e){function t(){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).apply(this,arguments)}return _inherits(t,e),_createClass(t,[{key:"download",value:function(e,t){t.preventDefault();var n=!1;document.getElementById(e.key)&&(n=document.getElementById(e.key)),ajaxArrayBuffer({key:e.key,arrayBuffer:!0,progress:n,success:function(t){var a=new Blob([t],{type:e.type}),r=URL.createObjectURL(a),o=document.createElement("a");o.href=r,o.download=e.name,document.body.appendChild(o);var i=document.createEvent("MouseEvents");i.initEvent("click",!0,!0),o.dispatchEvent(i),document.body.removeChild(o),n&&(n.value=0)}})}},{key:"render",value:function(){var e,t=this.props.data,n={display:"inline-block"},a={display:"block",marginTop:"-17px",marginRight:"1px",cursor:"pointer"};return e="image/png"===t.type||"image/jpeg"===t.type||"image/vnd.microsoft.icon"===t.type?React.createElement("div",null,React.createElement("div",{name:"enc-img","data-name":t.name,"data-type":t.type,"data-key":t.key},React.createElement("i",{className:"fa fa-spinner fa-pulse fa-2x"})),React.createElement("div",{className:"fa fa-external-link right",style:a,onClick:this.download.bind(this,t)})):React.createElement("div",{className:"attachment"},React.createElement(File,{key:t.key,data:t,dragStart:this.props.dragStart,download:this.download.bind(this,t)})),React.createElement("div",{style:n},e)}}]),t}(React.Component),File=function(e){function t(){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).apply(this,arguments)}return _inherits(t,e),_createClass(t,[{key:"render",value:function(){var e=this.props.data,t=e.name;return t.length>14&&(t.match(/[\u4e00-\u9fa5]/)?t=t.substring(0,14)+"...":t.length>24&&(t=t.substring(0,24)+"...")),React.createElement("div",null,React.createElement("a",{className:"item",title:e.name,"data-key":e.key,draggable:"true",onDragStart:this.props.dragStart,onClick:this.props.download},React.createElement("i",{className:fileTypeIcons(e.type)+" fa-fw fa-lg"})," ",t,React.createElement("span",{className:"right"},e.size)),React.createElement("div",{id:e.key,className:"item progress-bar"}))}}]),t}(React.Component),_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),_get=function(e,t,n){for(var a=!0;a;){var r=e,o=t,i=n;s=c=l=void 0,a=!1,null===r&&(r=Function.prototype);var s=Object.getOwnPropertyDescriptor(r,o);if(void 0!==s){if("value"in s)return s.value;var l=s.get;return void 0===l?void 0:l.call(i)}var c=Object.getPrototypeOf(r);if(null===c)return void 0;e=c,t=o,n=i,a=!0}},Contents=function(e){function t(e){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this,e),this.state={contents:[]}}return _inherits(t,e),_createClass(t,[{key:"sort",value:function(){if(0===this.state.contents.length){var e=this.props.contents.slice(0);e.sort(function(e,t){return e.title.localeCompare(t.title)}),this.setState({contents:e})}else clearInterval(this.interval)}},{key:"componentDidMount",value:function(){this.interval=setInterval(this.sort.bind(this),5)}},{key:"componentWillUnmount",value:function(){clearInterval(this.interval)}},{key:"render",value:function(){return React.createElement("div",{className:"wrap"},this.state.contents.map(function(e){return React.createElement("a",{className:"btn",key:e.id,href:"#/t/"+e.id,role:"button"},e.title)}))}}]),t}(React.Component),_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),_get=function(e,t,n){for(var a=!0;a;){var r=e,o=t,i=n;s=c=l=void 0,a=!1,null===r&&(r=Function.prototype);var s=Object.getOwnPropertyDescriptor(r,o);if(void 0!==s){if("value"in s)return s.value;var l=s.get;return void 0===l?void 0:l.call(i)}var c=Object.getPrototypeOf(r);if(null===c)return void 0;e=c,t=o,n=i,a=!0}},Editor=function(e){function t(e){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this,e),this.state={section:{id:"",title:"",content:""}}}return _inherits(t,e),_createClass(t,[{key:"tick",value:function(){var e=location.hash.slice(4);e?db.section.get(e,function(e){e&&(this.setState({section:e}),clearInterval(this.interval))}.bind(this)):clearInterval(this.interval)}},{key:"componentDidMount",value:function(){this.interval=setInterval(this.tick.bind(this),5)}},{key:"componentWillUnmount",value:function(){clearInterval(this.interval)}},{key:"handleTitleChange",value:function(e){var t=this.state.section;t.title=e.target.value,this.setState({section:t})}},{key:"handleContentChange",value:function(e){var t=this.state.section;t.content=e.target.value,this.setState({section:t})}},{key:"uploadFileSuccess",value:function(e,t){var n="\n!["+t.name+","+(t.size/1024).toFixed(2)+"KB,"+t.type+","+e+"]",a=document.getElementById("content");insertText(a,n);var r=this.state.section;r.content=a.value,this.setState({section:r})}},{key:"uploadSetToServer",value:function(e){e.preventDefault(),this.props.uploadSetToServer(this.state.section)}},{key:"render",value:function(){var e=this.state.section;return React.createElement("div",{className:"wrap"},React.createElement("form",{onSubmit:this.uploadSetToServer.bind(this)},React.createElement("div",{className:"form-group"},React.createElement("input",{type:"text",className:"form-control",placeholder:"key",onChange:this.handleTitleChange.bind(this),value:e.title})),React.createElement("div",{className:"form-group"},React.createElement("textarea",{id:"content",className:"form-control",rows:"17",placeholder:"value",onChange:this.handleContentChange.bind(this),value:e.content})),React.createElement("button",{type:"submit",className:"btn insert right"},"Save")),React.createElement(InputFile,{uploadFolder:"u/",uploadFileSuccess:this.uploadFileSuccess.bind(this)}))}}]),t}(React.Component),_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),_get=function(e,t,n){for(var a=!0;a;){var r=e,o=t,i=n;s=c=l=void 0,a=!1,null===r&&(r=Function.prototype);var s=Object.getOwnPropertyDescriptor(r,o);if(void 0!==s){if("value"in s)return s.value;var l=s.get;return void 0===l?void 0:l.call(i)}var c=Object.getPrototypeOf(r);if(null===c)return void 0;e=c,t=o,n=i,a=!0}},InputFile=function(e){function t(e){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this,e),this.state={i:0}}return _inherits(t,e),_createClass(t,[{key:"handleClick",value:function(e){e.preventDefault();var t=document.getElementById("file"),n=document.createEvent("MouseEvents");n.initEvent("click",!0,!0),t.dispatchEvent(n)}},{key:"handleChange",value:function(){var e=document.getElementById("file").files,t=this.state.i;if(t<e.length){var n=t+1;this.setState({i:n}),document.getElementById("file-info").innerHTML=e[t].name,this.readAndUpload(e[t])}else document.getElementById("file").value="",document.getElementById("file-info").innerHTML="选择文件上传",this.setState({i:0})}},{key:"readAndUpload",value:function(e){var t=new FileReader;t.onload=function(n){var a=this.props.uploadFolder+timeDiff();upload({key:a,data:t.result,arrayBuffer:!0,progress:document.getElementById("upload-progress"),success:function(){this.props.uploadFileSuccess(a,e),this.handleChange()}.bind(this)})}.bind(this),t.readAsArrayBuffer(e)}},{key:"render",value:function(){return React.createElement("div",{className:"attachment"},React.createElement("input",{id:"file",style:{display:"none"},type:"file",multiple:!0,onChange:this.handleChange.bind(this)}),React.createElement("a",{id:"file-info",className:"item",onClick:this.handleClick},"选择文件上传"),React.createElement("div",{id:"upload-progress",className:"item progress-bar"}))}}]),t}(React.Component),_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),_get=function(e,t,n){for(var a=!0;a;){var r=e,o=t,i=n;s=c=l=void 0,a=!1,null===r&&(r=Function.prototype);var s=Object.getOwnPropertyDescriptor(r,o);if(void 0!==s){if("value"in s)return s.value;var l=s.get;return void 0===l?void 0:l.call(i)}var c=Object.getPrototypeOf(r);if(null===c)return void 0;e=c,t=o,n=i,a=!0}},Navbar=function(e){function t(){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).apply(this,arguments)}return _inherits(t,e),_createClass(t,[{key:"handleIndexClick",value:function(e){e.preventDefault(),this.refs.mainput.getDOMNode().value="",location.href="#/"}},{key:"handleLogoutClick",value:function(e){e.preventDefault(),this.props.logout()}},{key:"handleLoginClick",value:function(e){e.preventDefault(),local=location.hash,location.href="#/login"}},{key:"handleMainputChange",value:function(e){e.preventDefault();var t=this.refs.mainput.getDOMNode().value;t.length>1?location.href="#/s/"+t:""===t&&(location.href="#/")}},{key:"preventDefault",value:function(e){e.preventDefault()}},{key:"drop",value:function(e){e.preventDefault();var t=e.dataTransfer.getData("key");""!==t&&upload({key:t,data:"x",success:function(){console.log("Erase!!!"),successInfo("Erase!!!")}.bind(this)})}},{key:"render",value:function(){var e;return e=this.props.auth?React.createElement("div",null,React.createElement("a",{className:"nav-site",href:"#/a"},React.createElement("span",{className:"fa fa-plus","aria-hidden":"true"})),React.createElement("div",{className:"nav-site",onDragOver:this.preventDefault,onDrop:this.drop.bind(this)},React.createElement("span",{className:"fa fa-trash-o","aria-hidden":"true"})),React.createElement("span",{className:"nav-site"}),React.createElement("a",{className:"nav-site",onClick:this.handleLogoutClick.bind(this)},React.createElement("span",{className:"fa fa-sign-out","aria-hidden":"true"}))):React.createElement("div",null,React.createElement("a",{className:"nav-site",onClick:this.handleLoginClick.bind(this)},React.createElement("span",{className:"fa fa-sign-in","aria-hidden":"true"}))),React.createElement("nav",{className:"nav-main"},React.createElement("div",{className:"wrap"},React.createElement("a",{className:"nav-site nav-title",onClick:this.handleIndexClick.bind(this)},siteTitle),React.createElement("form",{className:"nav-form left",role:"search",onSubmit:this.handleMainputChange.bind(this)},React.createElement("input",{type:"text",className:"form-control mainput",ref:"mainput",onChange:this.handleMainputChange.bind(this)})),React.createElement("div",{className:"right nav-right"},e)))}}]),t}(React.Component),_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),_get=function(e,t,n){for(var a=!0;a;){var r=e,o=t,i=n;s=c=l=void 0,a=!1,null===r&&(r=Function.prototype);var s=Object.getOwnPropertyDescriptor(r,o);if(void 0!==s){if("value"in s)return s.value;var l=s.get;return void 0===l?void 0:l.call(i)}var c=Object.getPrototypeOf(r);if(null===c)return void 0;e=c,t=o,n=i,a=!0}},Root=function(e){function t(e){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this,e),this.state={version:0,contents:[],set:[],auth:!1,url:location.hash,erase:!1}}return _inherits(t,e),_createClass(t,[{key:"loadSetFromServer",value:function(){ajaxArrayBuffer({key:"set/"+this.state.version,success:function(e){var t=[],n=!0,a=!1,r=void 0;try{for(var o,i=e.set[Symbol.iterator]();!(n=(o=i.next()).done);n=!0){var s=o.value,l={id:s.id,title:s.title,timestamp:s.timestamp};t.push(l)}}catch(c){a=!0,r=c}finally{try{!n&&i["return"]&&i["return"]()}finally{if(a)throw r}}this.setState({contents:t}),this.setState({set:e.set}),this.cacheToIndexedDB(),refresh=!0}.bind(this)})}},{key:"cacheToIndexedDB",value:function(){var e=this.state.version;db.etc.put({id:"version",version:e}),db.contents.put({id:e,arr:this.state.contents}),db.set.put({id:e,arr:this.state.set});var t=!0,n=!1,a=void 0;try{for(var r,o=this.state.set[Symbol.iterator]();!(t=(r=o.next()).done);t=!0){var i=r.value;db.section.put(i).then(function(){refresh=!0})}}catch(s){n=!0,a=s}finally{try{!t&&o["return"]&&o["return"]()}finally{if(n)throw a}}}},{key:"loadSetFromIndexedDB",value:function(){var e=this.state.version;db.contents.get(e,function(e){this.setState({contents:e.arr})}.bind(this)),db.set.get(e,function(e){this.setState({set:e.arr})}.bind(this))}},{key:"cache",value:function(){ajaxArrayBuffer({key:"version",success:function(e){this.setState({version:e.version}),db.etc.get("version",function(e){e&&e.version===this.state.version?(console.log("LoadSetFromIndexedDB"),this.loadSetFromIndexedDB()):(console.log("LoadSetFromServer"),this.loadSetFromServer())}.bind(this))}.bind(this)})}},{key:"handleUploadSetToServer",value:function(e){if(""!==e.title){var t=this.state.version+1,n=this.state.contents,a=this.state.set,r={id:e.id,title:e.title,timestamp:Date.now()};if(""===r.id)r.id=timeDiff(),n.push(r),r.content=e.content,a.push(r);else for(var o in n)r.id===n[o].id&&(n[o]=r,r.content=e.content,a[o]=r);this.setState({version:t}),this.setState({contents:n}),this.setState({set:a}),db.section.put(r),db.etc.put({id:"version",version:t}),db.contents.put({id:t,arr:n}),db.set.put({id:t,arr:a}),upload({key:"set/"+t,data:JSON.stringify({set:a}),success:function(){upload({key:"version",data:JSON.stringify({version:t}),success:function(){console.log("Save!!!"),location.href="#/t/"+r.id}})}})}}},{key:"handleLogin",value:function(){this.setState({auth:!0}),location.href="#/login"===local?"#/":local}},{key:"handleLogout",value:function(){localStorage.removeItem("token"),localStorage.removeItem("user"),this.setState({auth:!1}),location.replace("#/")}},{key:"auth",value:function(){localStorage.token&&this.setState({auth:!0})}},{key:"componentDidMount",value:function(){var e=this;this.auth(),this.cache(),window.onhashchange=function(){return e.setState({url:location.hash})}}},{key:"render",value:function(){var e;switch(this.state.url.split("/")[1]){case"t":case"s":e=React.createElement(Section,this.state);break;case"a":case"e":e=React.createElement(Editor,_extends({},this.state,{uploadSetToServer:this.handleUploadSetToServer.bind(this)}));break;case"login":e=React.createElement(SignIn,_extends({},this.state,{login:this.handleLogin.bind(this)}));break;case"join":e=React.createElement(SignUp,this.state);break;default:e=React.createElement(Contents,this.state)}return React.createElement("div",null,React.createElement(Navbar,{auth:this.state.auth,logout:this.handleLogout.bind(this)}),e)}}]),t}(React.Component),_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),_get=function(e,t,n){for(var a=!0;a;){var r=e,o=t,i=n;s=c=l=void 0,a=!1,null===r&&(r=Function.prototype);var s=Object.getOwnPropertyDescriptor(r,o);if(void 0!==s){if("value"in s)return s.value;var l=s.get;return void 0===l?void 0:l.call(i)}var c=Object.getPrototypeOf(r);if(null===c)return void 0;e=c,t=o,n=i,a=!0}},Section=function(e){function t(e){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this,e),this.state={section:[],keyword:""}}return _inherits(t,e),_createClass(t,[{key:"dragStart",value:function(e){var t=e.target.dataset.key;e.dataTransfer.setData("key",t)}},{key:"loadIMG",value:function(e){ajaxArrayBuffer({key:e.dataset.key,arrayBuffer:!0,success:function(t){var n=new Blob([t],{type:e.dataset.type}),a=URL.createObjectURL(n),r=document.createElement("img");r.src=a,r.title=e.dataset.name,r.dataset.key=e.dataset.key,r.ondragstart=this.dragStart,e.replaceChild(r,e.firstElementChild),e.setAttribute("name","dec-img")}.bind(this)})}},{key:"imgEvent",value:function(){for(var e=document.getElementsByName("enc-img"),t=0;t<e.length;t++){var n=e[t].getBoundingClientRect().top;n>0&&n<window.innerHeight&&this.loadIMG(e[t])}}},{key:"query",value:function n(){var e={id:"",keyword:""};if("t"===location.hash.slice(2,3)?e.id=location.hash.slice(4):e.keyword=location.hash.slice(4),""!==e.id)refresh&&(console.log("Index"),db.section.get(e.id,function(e){e&&(this.setState({section:[e]}),refresh=!1,0!==document.getElementsByName("enc-img").length?(this.imgEvent(),window.onscroll=this.imgEvent.bind(this)):window.onscroll=null)}.bind(this)));else if(""!==e.keyword&&0!==this.props.set.length){var t=e.keyword;if(t!==this.state.keyword||refresh){console.log("Query");var n=[],a=new RegExp(t,"i"),r=!0,o=!1,i=void 0;try{for(var s,l=this.props.set[Symbol.iterator]();!(r=(s=l.next()).done);r=!0){var c=s.value;(null!==c.title.match(a)||null!==c.content.match(a))&&n.push(c)}}catch(u){o=!0,i=u}finally{try{!r&&l["return"]&&l["return"]()}finally{if(o)throw i}}this.setState({section:n}),this.setState({keyword:t}),refresh=!1,0!==document.getElementsByName("enc-img").length?(this.imgEvent(),window.onscroll=this.imgEvent.bind(this)):window.onscroll=null}}}},{key:"componentDidMount",value:function(){refresh=!0,this.query(),this.interval=setInterval(this.query.bind(this),200)}},{key:"componentWillUnmount",value:function(){clearInterval(this.interval)}},{key:"render",value:function(){return React.createElement("div",null,this.state.section.map(function(e){return React.createElement(Fragment,{key:e.id,data:e,auth:this.props.auth,dragStart:this.dragStart.bind(this)})}.bind(this)))}}]),t}(React.Component),Fragment=function(e){function t(){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).apply(this,arguments)}return _inherits(t,e),_createClass(t,[{key:"render",value:function(){var e=this.props.data,t=React.createElement("h1",null,e.title);this.props.auth&&(t=React.createElement("h1",null,React.createElement("a",{href:"#/e/"+e.id,title:"编辑"},e.title)));for(var n=e.content.split(/(!\[.*?,.*?,.*?,.*?\])/),a=0;a<n.length;a++)if(a%2===0){if(""!==n[a]){var r=md.render(n[a]);n[a]=React.createElement("section",{dangerouslySetInnerHTML:{__html:r}})}}else{var o=n[a].match(/!\[(.*?),(.*?),(.*?),(.*?)\]/),i={name:o[1],size:o[2],type:o[3],key:o[4]};n[a]=React.createElement(Attachment,{data:i,dragStart:this.props.dragStart})}return React.createElement("div",null,React.createElement("article",{className:"wrap"},t,n),React.createElement("hr",null))}}]),t}(React.Component),_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),_get=function(e,t,n){for(var a=!0;a;){var r=e,o=t,i=n;s=c=l=void 0,a=!1,null===r&&(r=Function.prototype);var s=Object.getOwnPropertyDescriptor(r,o);if(void 0!==s){if("value"in s)return s.value;var l=s.get;return void 0===l?void 0:l.call(i)}var c=Object.getPrototypeOf(r);if(null===c)return void 0;e=c,t=o,n=i,a=!0}},SignIn=function(e){function t(){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).apply(this,arguments)}return _inherits(t,e),_createClass(t,[{key:"handleSubmit",value:function(e){e.preventDefault();var t=this.refs.name.getDOMNode().value,n=this.refs.passwd.getDOMNode().value;ajaxArrayBuffer({key:t,token:n,success:function(e){localStorage.token=e.user.token,localStorage.user=JSON.stringify(e.user),this.props.login(),this.refs.name.getDOMNode().value="",this.refs.passwd.getDOMNode().value=""}.bind(this)})}},{key:"render",value:function(){return React.createElement("div",{className:"wrap"},React.createElement("form",{onSubmit:this.handleSubmit.bind(this)},React.createElement("div",{className:"form-group"},React.createElement("label",{htmlFor:"inputName3"},"Name"),React.createElement("input",{type:"text",className:"form-control",id:"inputName3",ref:"name"})),React.createElement("div",{className:"form-group"},React.createElement("label",{htmlFor:"inputPassword3"},"Password"),React.createElement("input",{type:"password",className:"form-control",id:"inputPassword3",ref:"passwd"})),React.createElement("button",{type:"submit",className:"btn"},"Sign in")))}}]),t}(React.Component),_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),_get=function(e,t,n){for(var a=!0;a;){var r=e,o=t,i=n;s=c=l=void 0,a=!1,null===r&&(r=Function.prototype);var s=Object.getOwnPropertyDescriptor(r,o);if(void 0!==s){if("value"in s)return s.value;var l=s.get;return void 0===l?void 0:l.call(i)}var c=Object.getPrototypeOf(r);if(null===c)return void 0;e=c,t=o,n=i,a=!0}},SignUp=function(e){function t(){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).apply(this,arguments)}return _inherits(t,e),_createClass(t,[{key:"handleSubmit",value:function(e){e.preventDefault();var t=this.refs.name.getDOMNode().value,n=this.refs.passwd.getDOMNode().value,a=this.refs.token.getDOMNode().value,r=this.refs.AK.getDOMNode().value,o=this.refs.SK.getDOMNode().value,i={AK:r,SK:o,token:a};localStorage.token=a,localStorage.user=JSON.stringify(i),upload({key:t,data:JSON.stringify({user:i}),token:n,success:function(){console.log("Success!"),successInfo("Success!!!")}.bind(this)})}},{key:"render",value:function(){return React.createElement("div",{className:"wrap"},React.createElement("form",{onSubmit:this.handleSubmit.bind(this)},React.createElement("div",{className:"form-group"},React.createElement("label",{htmlFor:"inputName3"},"Name"),React.createElement("input",{type:"text",className:"form-control",id:"inputName3",ref:"name"})),React.createElement("div",{className:"form-group"},React.createElement("label",{htmlFor:"inputPassword3"},"Password"),React.createElement("input",{type:"text",className:"form-control",id:"inputPassword3",ref:"passwd"})),React.createElement("div",{className:"form-group"},React.createElement("label",{htmlFor:"token"},"Token"),React.createElement("input",{type:"text",className:"form-control",id:"token",ref:"token"})),React.createElement("div",{className:"form-group"},React.createElement("label",{htmlFor:"AK"},"AK"),React.createElement("input",{type:"text",className:"form-control",id:"AK",ref:"AK"})),React.createElement("div",{className:"form-group"},React.createElement("label",{htmlFor:"SK"},"SK"),React.createElement("input",{type:"text",className:"form-control",id:"SK",ref:"SK"})),React.createElement("button",{type:"submit",className:"btn"},"Sign up")))}}]),t}(React.Component),local="#/",refresh=!1,md=window.markdownit({html:!0,breaks:!0,linkify:!0});